From sshtylyov@ru.mvista.com Thu May 17 19:45:16 2007
Return-Path: <sshtylyov@ru.mvista.com>
X-Spam-Checker-Version: SpamAssassin 3.1.7-deb (2006-10-05) on debian
X-Spam-Level: 
X-Spam-Status: No, score=0.0 required=5.0 tests=AWL autolearn=unavailable 
	version=3.1.7-deb
Received: from imap.sh.mvista.com (unknown [63.81.120.155]) by mail.tglx.de
	(Postfix) with ESMTP id E0E7965C065 for <tglx@linutronix.de>; Thu, 17 May
	2007 19:45:16 +0200 (CEST)
Received: from wasted.dev.rtsoft.ru (unknown [10.150.0.9]) by
	imap.sh.mvista.com (Postfix) with ESMTP id 323023EC9; Thu, 17 May 2007
	10:45:13 -0700 (PDT)
From: Sergei Shtylyov <sshtylyov@ru.mvista.com>
Organization: MontaVista Software Inc.
To: tglx@linutronix.de, mingo@elte.hu
Subject: [PATCH 2.6.21-rt2] PowerPC: enable HRT and dynticks support
Date: Thu, 17 May 2007 21:46:46 +0400
User-Agent: KMail/1.5
Cc: linuxppc-dev@ozlabs.org, linux-kernel@vger.kernel.org
MIME-Version: 1.0
Content-Disposition: inline
Content-Type: text/plain; charset="iso-8859-1"
Message-Id: <200705172146.46769.sshtylyov@ru.mvista.com>
X-Evolution-Source: imap://tglx%40linutronix.de@localhost:8993/
Content-Transfer-Encoding: 8bit

Enable HRT and dynamic ticks support for PowerPC.

Signed-off-by: Sergei Shtylyov <sshtylyov@ru.mvista.com>

---
This patch has been reworked against the 2.6.21 clockevents framework.
It has only been tested on the Book E 32-bit CPU this time, so re-testing on
"classic" PowerPC CPUs is needed (there have been issues as of 2.6.18-rt7 but
those should now be fixed)...

 arch/powerpc/Kconfig       |    1 +
 arch/powerpc/kernel/idle.c |    6 ++++++
 2 files changed, 7 insertions(+)

Index: linux-2.6.23.1-rt5/arch/powerpc/Kconfig
===================================================================
--- linux-2.6.23.1-rt5.orig/arch/powerpc/Kconfig
+++ linux-2.6.23.1-rt5/arch/powerpc/Kconfig
@@ -171,6 +171,7 @@ config GENERIC_CLOCKEVENTS
 	  NOTE: This is not compatible with the deterministic time accounting
 	  option on PPC64.
 
+source kernel/time/Kconfig
 source kernel/Kconfig.preempt
 source "fs/Kconfig.binfmt"
 
Index: linux-2.6.23.1-rt5/arch/powerpc/kernel/idle.c
===================================================================
--- linux-2.6.23.1-rt5.orig/arch/powerpc/kernel/idle.c
+++ linux-2.6.23.1-rt5/arch/powerpc/kernel/idle.c
@@ -24,6 +24,7 @@
 #include <linux/smp.h>
 #include <linux/cpu.h>
 #include <linux/sysctl.h>
+#include <linux/tick.h>
 
 #include <asm/system.h>
 #include <asm/processor.h>
@@ -59,6 +60,8 @@ void cpu_idle(void)
 
 	set_thread_flag(TIF_POLLING_NRFLAG);
 	while (1) {
+		tick_nohz_stop_sched_tick();
+
 		while (!need_resched() && !cpu_should_die()) {
 			ppc64_runlatch_off();
 
@@ -92,6 +95,9 @@ void cpu_idle(void)
 		ppc64_runlatch_on();
 		if (cpu_should_die())
 			cpu_die();
+
+		tick_nohz_restart_sched_tick();
+
 		preempt_enable_no_resched();
 		schedule();
 		preempt_disable();
