#!/bin/sh

PATH=/sbin:/bin:/usr/sbin:/usr/bin:$PATH

DATAPATH=$1

#cd $DATAPATH

filesize() {
    local TMPSIZE;
    TMPSIZE=`wc -c $1`
    TMPSIZE=`echo $TMPSIZE | cut -d' ' -f1`
    echo $TMPSIZE
}

UBOOTOK=""

for f in $DATAPATH/u-boot.bin $DATAPATH/U-BOOT.BIN; do
    if [ -e $f ]; then
	FSIZE=`filesize $f`
	echo "$f $FSIZE"
	nandlogical /dev/mtd1 READ 0 $FSIZE /tmp/sharploader.bin
	nandlogical /dev/mtd1 WRITE 0 $FSIZE $f
	UBOOTOK="y"
	FSIZE1=$FSIZE
	break
    fi
done

if [ "x$UBOOTOK" = "x" ]; then
    echo "U-boot installation failed."
    echo "Check files and try again."
    reboot
fi

EMERGOK=""

for f in $DATAPATH/emergenc.img $DATAPATH/EMERGENC.IMG; do
    if [ -e $f ]; then
	FSIZE=`filesize $f`
	echo "$f $FSIZE"
	nandlogical /dev/mtd1 WRITE 0x60000 $FSIZE $f
	EMERGOK="y"
	break
    fi
done

echo "U-boot bootloader installed."
if [ "x$EMERGOK" = "x" ]; then
    nandlogical /dev/mtd1 WRITE 0 $FSIZE1 /tmp/sharploader.bin
    echo "But emergency system not."
    echo "Check files and try again."
else
    echo "Emergency system installed."
    echo "Press and hold OK during reboot"
    echo "or power up for run emergency system."
fi

reboot
